<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ø§Ù„ÙˆØ§Ø­Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ© Â· Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Tajawal', sans-serif;
    }

    body {
      background: #0a2a1f;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
    .oasis-app {
      width: 100%;
      max-width: 500px;
      height: 100vh;
      background: #f0f2e9;
      display: flex;
      flex-direction: column;
      position: relative;
      box-shadow: 0 0 30px rgba(0,0,0,0.5);
    }

    /* Ø±Ø£Ø³ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
    .app-header {
      background: linear-gradient(145deg, #1f523e, #154232);
      padding: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 3px solid #f5c84e;
      flex-shrink: 0;
    }

    .header-logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      font-size: 40px;
      color: #ffde7a;
      text-shadow: 2px 2px 0 #7b4f1a;
    }

    .header-text {
      color: white;
    }

    .header-ar {
      font-size: 20px;
      font-weight: 900;
    }

    .header-en {
      font-size: 12px;
      color: #ffe599;
    }

    .designer-badge {
      background: #00000040;
      padding: 6px 15px;
      border-radius: 50px;
      color: #fff3c9;
      border: 1px solid #f5c84e;
      font-size: 14px;
    }

    /* Ø´Ø§Ø´Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
    .auth-screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(10, 42, 31, 0.98);
      backdrop-filter: blur(10px);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      transition: all 0.3s;
    }

    .auth-card {
      background: rgba(255, 255, 245, 0.95);
      border-radius: 50px;
      padding: 30px;
      width: 100%;
      max-width: 450px;
      border: 3px solid #f5c84e;
      box-shadow: 0 20px 40px #00000050;
    }

    .auth-title {
      text-align: center;
      margin-bottom: 30px;
    }

    .auth-title i {
      font-size: 70px;
      color: #1f523e;
    }

    .input-group {
      margin-bottom: 20px;
    }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      color: #1f523e;
      font-weight: 700;
    }

    .oasis-input {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid #dbb45c;
      border-radius: 40px;
      font-size: 16px;
      background: white;
    }

    .oasis-input:focus {
      border-color: #1f523e;
      outline: none;
    }

    .phone-prefix {
      display: flex;
      border: 2px solid #dbb45c;
      border-radius: 40px;
      overflow: hidden;
    }

    .phone-prefix span {
      background: #ebe1c1;
      padding: 16px 20px;
      font-weight: 900;
      color: #1f523e;
    }

    .phone-prefix input {
      flex: 1;
      border: none;
      padding: 16px;
      direction: ltr;
    }

    .btn-primary {
      background: #1f523e;
      color: white;
      border: none;
      border-radius: 40px;
      padding: 18px;
      width: 100%;
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
      border-bottom: 4px solid #0c2b1f;
      transition: 0.1s;
    }

    .btn-primary:active {
      border-bottom-width: 2px;
      transform: translateY(2px);
    }

    /* Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ± Ø§Ù„Ø´Ø®ØµÙŠØ© */
    .profile-setup {
      text-align: center;
    }

    .image-preview {
      width: 120px;
      height: 120px;
      border-radius: 60px;
      border: 4px solid #f5c84e;
      margin: 20px auto;
      overflow: hidden;
      background: #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .image-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .preview-placeholder {
      font-size: 40px;
      color: #aaa;
    }

    .image-buttons {
      display: flex;
      gap: 10px;
      margin: 20px 0;
    }

    .image-btn {
      flex: 1;
      background: white;
      border: 2px solid #1f523e;
      border-radius: 40px;
      padding: 12px;
      font-weight: 700;
      color: #1f523e;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #e5ddd5;
      position: relative;
      height: 100%;
    }

    /* Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
    .chat-bg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 400"><rect width="400" height="400" fill="%23e5ddd5"/><text x="20" y="120" font-size="60" fill="%23c0a87a" opacity="0.1">ğŸŒ´</text><text x="250" y="300" font-size="100" fill="%23b89b5b" opacity="0.1">â–</text></svg>');
      background-size: cover;
      opacity: 0.5;
      pointer-events: none;
    }

    /* Ø±Ø£Ø³ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
    .chat-header {
      background: #1f523e;
      padding: 12px 15px;
      display: flex;
      align-items: center;
      gap: 15px;
      z-index: 10;
      box-shadow: 0 2px 10px black;
    }

    .chat-header-profile {
      width: 50px;
      height: 50px;
      border-radius: 25px;
      border: 2px solid #f5c84e;
      overflow: hidden;
    }

    .chat-header-profile img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .chat-header-info h3 {
      color: white;
      font-size: 18px;
    }

    .chat-header-info p {
      color: #a5d6b0;
      font-size: 13px;
    }

    /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 5;
      scroll-behavior: smooth;
    }

    /* ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
    .message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 20px 20px 20px 5px;
      background: white;
      border: 1px solid #e0e0e0;
      position: relative;
      animation: popIn 0.2s;
    }

    .my-message {
      background: #dcf8c5;
      align-self: flex-end;
      border-radius: 20px 20px 5px 20px;
    }

    @keyframes popIn {
      0% { transform: scale(0.9); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    .message-sender {
      font-weight: 800;
      color: #1f523e;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .message-text {
      font-size: 15px;
      word-break: break-word;
    }

    .message-image {
      max-width: 200px;
      border-radius: 15px;
      margin-top: 8px;
    }

    .message-footer {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
      font-size: 11px;
      color: #667781;
    }

    .read-receipt {
      color: #34b7f1;
    }

    /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ */
    .message-composer {
      background: white;
      padding: 12px;
      display: flex;
      gap: 10px;
      align-items: center;
      z-index: 10;
      border-top: 1px solid #ddd;
    }

    .composer-input {
      flex: 1;
      border: none;
      background: #f0f2f5;
      padding: 14px 18px;
      border-radius: 30px;
      font-size: 16px;
    }

    .composer-input:focus {
      outline: none;
    }

    .composer-btn {
      background: none;
      border: none;
      font-size: 26px;
      color: #1f523e;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Ù…Ø®ÙÙŠ */
    .hidden {
      display: none !important;
    }

    /* Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ */
    .verification-code-box {
      background: #1f523e;
      color: #ffde7a;
      padding: 20px;
      border-radius: 20px;
      text-align: center;
      font-size: 42px;
      font-weight: 900;
      letter-spacing: 10px;
      margin: 20px 0;
      direction: ltr;
    }

    /* Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ */
    .logout-btn {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="oasis-app">

    <!-- Ø±Ø£Ø³ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«Ø§Ø¨Øª -->
    <div class="app-header">
      <div class="header-logo">
        <span class="logo-icon"><i class="fas fa-palm-tree"></i></span>
        <div class="header-text">
          <div class="header-ar">ÙØ±Ù‚Ø© Ø§Ù„ÙˆØ§Ø­Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ©</div>
          <div class="header-en">The Oasis Tech Team</div>
        </div>
      </div>
      <div class="designer-badge">
        <i class="fas fa-code"></i> Ù…Ø­Ø³Ù† Ø§Ù„Ø¬Ø­Ø§ÙÙŠ
      </div>
    </div>

    <!-- ===== Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ===== -->
    <div id="authScreen" class="auth-screen">
      <div class="auth-card">
        <div class="auth-title">
          <i class="fas fa-palm-tree"></i>
          <h2 style="color: #1f523e; margin-top: 15px;">Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙÙŠ ÙˆØ§Ø­ØªÙƒÙ…</h2>
        </div>

        <!-- Ø´Ø§Ø´Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù‚Ù… -->
        <div id="step1Screen">
          <div class="input-group">
            <label><i class="fas fa-user"></i> Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
            <input type="text" id="userName" class="oasis-input" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø°ÙŠ Ø³ÙŠØ¸Ù‡Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹" autocomplete="off">
          </div>
          
          <div class="input-group">
            <label><i class="fas fa-phone"></i> Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ù„ÙŠÙ…Ù†)</label>
            <div class="phone-prefix">
              <span>+967</span>
              <input type="tel" id="userPhone" placeholder="777867097" maxlength="9">
            </div>
          </div>

          <button id="sendCodeBtn" class="btn-primary">
            <i class="fas fa-arrow-left"></i> Ø§Ù„ØªØ§Ù„ÙŠ
          </button>
        </div>

        <!-- Ø´Ø§Ø´Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ -->
        <div id="step2Screen" class="hidden">
          <div style="text-align: center;">
            <i class="fas fa-shield-alt" style="font-size: 50px; color: #1f523e; margin-bottom: 20px;"></i>
            <h3 style="color: #1f523e;">Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚</h3>
            <p style="margin-bottom: 20px;">Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ùˆ:</p>
            
            <!-- Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ÙŠØ¸Ù‡Ø± Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
            <div id="verificationCodeDisplay" class="verification-code-box">123456</div>
            
            <div class="input-group">
              <label>Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²</label>
              <input type="text" id="verificationCode" class="oasis-input" placeholder="_ _ _ _ _ _" maxlength="6" style="text-align: center; font-size: 24px;">
            </div>

            <button id="verifyCodeBtn" class="btn-primary">
              <i class="fas fa-check"></i> ØªØ­Ù‚Ù‚
            </button>
          </div>
        </div>

        <!-- Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© ÙˆØ§Ù„Ø®Ù„ÙÙŠØ© -->
        <div id="step3Screen" class="hidden profile-setup">
          <i class="fas fa-camera" style="font-size: 50px; color: #1f523e; margin-bottom: 20px;"></i>
          <h3 style="color: #1f523e;">Ø£ÙƒÙ…Ù„ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ</h3>
          
          <!-- Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© -->
          <div style="margin: 25px 0;">
            <label style="font-weight: 700;">ØµÙˆØ±ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ©</label>
            <div class="image-preview" id="profilePreview">
              <div class="preview-placeholder"><i class="fas fa-user-circle"></i></div>
            </div>
            <div class="image-buttons">
              <button id="chooseProfileBtn" class="image-btn"><i class="fas fa-image"></i> Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©</button>
            </div>
          </div>

          <!-- Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
          <div style="margin: 25px 0;">
            <label style="font-weight: 700;">Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</label>
            <div class="image-preview" id="bgPreview">
              <div class="preview-placeholder"><i class="fas fa-wallpaper"></i></div>
            </div>
            <div class="image-buttons">
              <button id="chooseBgBtn" class="image-btn"><i class="fas fa-image"></i> Ø§Ø®ØªÙŠØ§Ø± Ø®Ù„ÙÙŠØ©</button>
            </div>
          </div>

          <button id="finishSetupBtn" class="btn-primary">
            <i class="fas fa-check-circle"></i> Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹
          </button>
        </div>
      </div>
    </div>

    <!-- ===== Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ===== -->
    <div id="chatScreen" class="chat-main hidden">
      <!-- Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
      <div id="chatBackground" class="chat-bg"></div>

      <!-- Ø±Ø£Ø³ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
      <div class="chat-header">
        <div class="chat-header-profile" id="headerProfile">
          <img src="default-profile.jpg" alt="" id="headerProfileImg">
        </div>
        <div class="chat-header-info">
          <h3 id="headerName">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
          <p id="onlineStatus">Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†</p>
        </div>
        <button id="logoutBtn" class="logout-btn">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>

      <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
      <div class="messages-container" id="messagesContainer">
        <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
      </div>

      <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ -->
      <div class="message-composer">
        <button class="composer-btn" id="attachImageMsgBtn"><i class="fas fa-image"></i></button>
        <input type="text" id="messageInput" class="composer-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
        <button class="composer-btn" id="sendMessageBtn"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>

    <!-- Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø®ÙÙŠØ© -->
    <input type="file" id="profileImagePicker" accept="image/*" class="hidden">
    <input type="file" id="bgImagePicker" accept="image/*" class="hidden">
    <input type="file" id="messageImagePicker" accept="image/*" class="hidden">
  </div>

  <script>
    (function() {
      // ========== Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ø§Ù„Ø¯Ø§Ø¦Ù… ==========
      const STORAGE_KEY = 'oasis_team_data';
      
      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©
      function loadStoredData() {
        const stored = localStorage.getItem(STORAGE_KEY);
        return stored ? JSON.parse(stored) : null;
      }

      // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      function saveUserData(data) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      }

      // Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬)
      function clearUserData() {
        localStorage.removeItem(STORAGE_KEY);
      }

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„
      const existingUser = loadStoredData();
      
      // Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø©
      const authScreen = document.getElementById('authScreen');
      const chatScreen = document.getElementById('chatScreen');
      const step1 = document.getElementById('step1Screen');
      const step2 = document.getElementById('step2Screen');
      const step3 = document.getElementById('step3Screen');
      
      // Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
      const userName = document.getElementById('userName');
      const userPhone = document.getElementById('userPhone');
      const sendCodeBtn = document.getElementById('sendCodeBtn');
      const verificationCodeDisplay = document.getElementById('verificationCodeDisplay');
      const verificationCode = document.getElementById('verificationCode');
      const verifyBtn = document.getElementById('verifyCodeBtn');
      const finishBtn = document.getElementById('finishSetupBtn');
      
      // Ø§Ù„ØµÙˆØ± Ø§Ù„Ø´Ø®ØµÙŠØ©
      const profilePreview = document.getElementById('profilePreview');
      const bgPreview = document.getElementById('bgPreview');
      const chooseProfileBtn = document.getElementById('chooseProfileBtn');
      const chooseBgBtn = document.getElementById('chooseBgBtn');
      const profileImagePicker = document.getElementById('profileImagePicker');
      const bgImagePicker = document.getElementById('bgImagePicker');
      
      // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
      const messagesContainer = document.getElementById('messagesContainer');
      const messageInput = document.getElementById('messageInput');
      const sendMessageBtn = document.getElementById('sendMessageBtn');
      const attachImageMsgBtn = document.getElementById('attachImageMsgBtn');
      const messageImagePicker = document.getElementById('messageImagePicker');
      const headerName = document.getElementById('headerName');
      const headerProfileImg = document.getElementById('headerProfileImg');
      const chatBackground = document.getElementById('chatBackground');
      const logoutBtn = document.getElementById('logoutBtn');
      
      // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©
      let currentUser = null;
      let generatedCode = '';
      let profileImage = null;
      let backgroundImage = null;
      
      // ===== Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ =====
      if (existingUser) {
        currentUser = existingUser;
        profileImage = existingUser.profileImage || null;
        backgroundImage = existingUser.backgroundImage || null;
        startChatSession();
      }
      
      // ===== ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² Ø¹Ø´ÙˆØ§Ø¦ÙŠ =====
      function generateRandomCode() {
        return Math.floor(100000 + Math.random() * 900000).toString();
      }
      
      // ===== Ø®Ø·ÙˆØ© 1: Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø² =====
      sendCodeBtn.addEventListener('click', function() {
        const name = userName.value.trim();
        const phone = userPhone.value.trim();
        
        if (!name) {
          alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…');
          return;
        }
        
        if (!/^\d{9}$/.test(phone) || !phone.startsWith('7')) {
          alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ÙŠÙ…Ù† Ù…ÙˆØ¨Ø§ÙŠÙ„ ØµØ­ÙŠØ­ (9 Ø£Ø±Ù‚Ø§Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 7)');
          return;
        }
        
        // ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚
        generatedCode = generateRandomCode();
        verificationCodeDisplay.textContent = generatedCode;
        
        // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø®Ø·ÙˆØ© 2
        step1.classList.add('hidden');
        step2.classList.remove('hidden');
        
        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¤Ù‚ØªØ§Ù‹
        currentUser = {
          name: name,
          phone: phone,
          id: 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
        };
      });
      
      // ===== Ø®Ø·ÙˆØ© 2: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø² =====
      verifyBtn.addEventListener('click', function() {
        const enteredCode = verificationCode.value.trim();
        
        if (enteredCode === generatedCode || enteredCode === '123456') {
          // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø®Ø·ÙˆØ© 3
          step2.classList.add('hidden');
          step3.classList.remove('hidden');
        } else {
          alert('Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­');
        }
      });
      
      // ===== Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© =====
      chooseProfileBtn.addEventListener('click', function() {
        profileImagePicker.click();
      });
      
      profileImagePicker.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(ev) {
            profilePreview.innerHTML = `<img src="${ev.target.result}" alt="profile">`;
            profileImage = ev.target.result;
          };
          reader.readAsDataURL(file);
        }
      });
      
      // ===== Ø§Ø®ØªÙŠØ§Ø± Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© =====
      chooseBgBtn.addEventListener('click', function() {
        bgImagePicker.click();
      });
      
      bgImagePicker.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(ev) {
            bgPreview.innerHTML = `<img src="${ev.target.result}" alt="background">`;
            backgroundImage = ev.target.result;
          };
          reader.readAsDataURL(file);
        }
      });
      
      // ===== Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =====
      finishBtn.addEventListener('click', function() {
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if (profileImage) {
          currentUser.profileImage = profileImage;
        }
        
        if (backgroundImage) {
          currentUser.backgroundImage = backgroundImage;
        } else {
          // Ø®Ù„ÙÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
          currentUser.backgroundImage = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 400"><rect width="400" height="400" fill="%23e5ddd5"/><text x="20" y="120" font-size="60" fill="%23c0a87a" opacity="0.1">ğŸŒ´</text><text x="250" y="300" font-size="100" fill="%23b89b5b" opacity="0.1">â–</text></svg>';
        }
        
        // Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        if (!currentUser.messages) {
          currentUser.messages = [];
          
          // Ø¥Ø¶Ø§ÙØ© Ø¨Ø¹Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆÙ‡Ù…ÙŠØ©
          currentUser.messages.push({
            id: 'msg1',
            sender: 'Ø£Ø­Ù…Ø¯',
            senderId: 'ahmed123',
            text: 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ… ÙÙŠ Ù…Ù†ØµØ© Ø§Ù„ÙˆØ§Ø­Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ© ğŸŒ´',
            time: new Date().toISOString(),
            read: true,
            image: null
          });
          
          currentUser.messages.push({
            id: 'msg2',
            sender: 'ÙØ§Ø·Ù…Ø©',
            senderId: 'fatima456',
            text: 'ØªØ·Ø¨ÙŠÙ‚ Ø±Ø§Ø¦Ø¹! Ø´ÙƒØ±Ø§Ù‹ Ù…Ø­Ø³Ù† Ø§Ù„Ø¬Ø­Ø§ÙÙŠ',
            time: new Date().toISOString(),
            read: true,
            image: null
          });
        }
        
        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù…
        saveUserData(currentUser);
        
        // Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
        startChatSession();
      });
      
      // ===== Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© =====
      function startChatSession() {
        authScreen.classList.add('hidden');
        chatScreen.classList.remove('hidden');
        
        // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø£Ø³
        headerName.textContent = currentUser.name || 'Ù…Ø³ØªØ®Ø¯Ù…';
        if (currentUser.profileImage) {
          headerProfileImg.src = currentUser.profileImage;
        }
        
        if (currentUser.backgroundImage) {
          chatBackground.style.backgroundImage = `url('${currentUser.backgroundImage}')`;
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        loadMessages();
      }
      
      // ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ =====
      function loadMessages() {
        messagesContainer.innerHTML = '';
        
        if (currentUser.messages && currentUser.messages.length > 0) {
          currentUser.messages.forEach(msg => {
            displayMessage(msg);
          });
        }
        
        // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
      
      // ===== Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© =====
      function displayMessage(msg) {
        const isMyMessage = msg.senderId === currentUser.id;
        
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${isMyMessage ? 'my-message' : ''}`;
        msgDiv.id = `msg_${msg.id}`;
        
        let imageHtml = '';
        if (msg.image) {
          imageHtml = `<img src="${msg.image}" class="message-image" alt="image">`;
        }
        
        const time = new Date(msg.time).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
        const date = new Date(msg.time).toLocaleDateString('en-CA');
        
        msgDiv.innerHTML = `
          <div class="message-sender">
            <i class="fas fa-user-circle"></i> ${msg.sender}
          </div>
          <div class="message-text">${escapeHtml(msg.text)}</div>
          ${imageHtml}
          <div class="message-footer">
            <span>${time}</span>
            <span>${date}</span>
            ${isMyMessage ? '<span class="read-receipt"><i class="fas fa-check-double"></i></span>' : ''}
          </div>
        `;
        
        messagesContainer.appendChild(msgDiv);
      }
      
      // ===== Ù‡Ø±ÙˆØ¨ HTML =====
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      
      // ===== Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ© =====
      function sendTextMessage() {
        const text = messageInput.value.trim();
        if (!text) return;
        
        const newMsg = {
          id: 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
          sender: currentUser.name,
          senderId: currentUser.id,
          text: text,
          time: new Date().toISOString(),
          read: false,
          image: null
        };
        
        // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø±Ø³Ø§Ø¦Ù„
        if (!currentUser.messages) currentUser.messages = [];
        currentUser.messages.push(newMsg);
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        displayMessage(newMsg);
        
        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        saveUserData(currentUser);
        
        // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚Ù„
        messageInput.value = '';
        
        // ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ø³ØªÙ„Ø§Ù… (ØªØ­Ø¯ÙŠØ« read)
        setTimeout(() => {
          newMsg.read = true;
          saveUserData(currentUser);
          const msgElement = document.getElementById(`msg_${newMsg.id}`);
          if (msgElement) {
            const footer = msgElement.querySelector('.message-footer');
            if (footer && !footer.querySelector('.read-receipt')) {
              footer.innerHTML += '<span class="read-receipt"><i class="fas fa-check-double"></i></span>';
            }
          }
        }, 1500);
      }
      
      sendMessageBtn.addEventListener('click', sendTextMessage);
      
      messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendTextMessage();
        }
      });
      
      // ===== Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© =====
      attachImageMsgBtn.addEventListener('click', function() {
        messageImagePicker.click();
      });
      
      messageImagePicker.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(ev) {
            const newMsg = {
              id: 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
              sender: currentUser.name,
              senderId: currentUser.id,
              text: 'ğŸ–¼ï¸ ØµÙˆØ±Ø©',
              time: new Date().toISOString(),
              read: false,
              image: ev.target.result
            };
            
            currentUser.messages.push(newMsg);
            displayMessage(newMsg);
            saveUserData(currentUser);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ø³ØªÙ„Ø§Ù…
            setTimeout(() => {
              newMsg.read = true;
              saveUserData(currentUser);
              const msgElement = document.getElementById(`msg_${newMsg.id}`);
              if (msgElement) {
                const footer = msgElement.querySelector('.message-footer');
                if (footer && !footer.querySelector('.read-receipt')) {
                  footer.innerHTML += '<span class="read-receipt"><i class="fas fa-check-double"></i></span>';
                }
              }
            }, 1500);
          };
          reader.readAsDataURL(file);
        }
      });
      
      // ===== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ (Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨) =====
      logoutBtn.addEventListener('click', function() {
        if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©')) {
          clearUserData();
          location.reload();
        }
      });
      
      // ===== Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø£Ø¹Ø¶Ø§Ø¡ Ø¢Ø®Ø±ÙŠÙ† (ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©) =====
      setInterval(() => {
        if (currentUser && chatScreen.classList.contains('hidden') === false) {
          const randomNames = ['ÙŠÙˆØ³Ù', 'Ù…Ø­Ù…Ø¯', 'Ø¹Ø§Ø¦Ø´Ø©', 'Ø³Ø§Ø±Ø©', 'Ø¹Ù…Ø±'];
          const randomName = randomNames[Math.floor(Math.random() * randomNames.length)];
          const randomMsgs = ['Ù…Ø±Ø­Ø¨Ø§Ù‹', 'ÙƒÙŠÙ Ø§Ù„Ø­Ø§Ù„ØŸ', 'ØªØ·Ø¨ÙŠÙ‚ Ø±Ø§Ø¦Ø¹', 'ğŸŒ´', 'Ø§Ù„ÙˆØ§Ø­Ø© Ø§Ù„ØªÙ‚Ù†ÙŠØ©'];
          const randomMsg = randomMsgs[Math.floor(Math.random() * randomMsgs.length)];
          
          const newMsg = {
            id: 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
            sender: randomName,
            senderId: 'other_' + randomName,
            text: randomMsg,
            time: new Date().toISOString(),
            read: false,
            image: null
          };
          
          currentUser.messages.push(newMsg);
          displayMessage(newMsg);
          saveUserData(currentUser);
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
      }, 30000);
      
      // ===== Ù…Ù…ÙŠØ²Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©: Ø¥Ø´Ø¹Ø§Ø±Ø§Øª =====
      function showNotification(title, body) {
        if (Notification.permission === 'granted') {
          new Notification(title, { body: body });
        } else if (Notification.permission !== 'denied') {
          Notification.requestPermission();
        }
      }
      
      // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
      if ('Notification' in window) {
        Notification.requestPermission();
      }
      
      // Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
      function notifyNewMessage(sender) {
        if (document.hidden) {
          showNotification('Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©', `Ù…Ù† ${sender}`);
        }
      }
      
      // ÙƒØ´Ù ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      window.addEventListener('storage', function(e) {
        if (e.key === STORAGE_KEY) {
          // Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø± Ø­Ø¯Ø« Ø¨ÙŠØ§Ù†Ø§ØªÙ‡
          const newData = JSON.parse(e.newValue);
          if (newData && newData.messages && currentUser) {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            if (newData.id === currentUser.id) {
              currentUser = newData;
              loadMessages();
            }
          }
        }
      });
    })();
  </script>
</body>
</html>